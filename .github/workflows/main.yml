name: CI
on: push
env:
  name: |
    iris-community
    irishealth-community
  matrix: |
    {
      "iris-community:2021.2.0.651.0": {
        "name": "iris-community",
        "version": "2021.2.0.651.0"
      },
      "iris-community:2022.2.0.334.0": {
        "name": "iris-community",
        "version": "2022.2.0.334.0"
      },
      "iris-community:2022.1.0.209.0": {
        "name": "iris-community",
        "version": "2022.1.0.209.0"
      }
    }
jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          echo ::set-output name=matrix::"${{ env.matrix }}"
          # echo ::set-output name=matrix::`jq -Rsc 'split("\n") | map(select(length > 0))' <<< $'${{ env.name }}' `
          # echo ::set-output name=version::`jq -Rsc 'split("\n") | map(select(length > 0))' <<< $'${{ env.latest }}\n${{ env.version }}\n${{ env.preview }}' `
  matrix:
    runs-on: ubuntu-latest
    needs: 
      - prepare-matrix
    steps:
      - run: echo "${{ needs.prepare-matrix.outputs.matrix }}"
  build:
    # needs: 
    #   - prepare-matrix
    strategy:
      matrix: 
        image: ${{ fromJSON(needs.prepare-matrix.outputs.matrix) }}
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Dump job context
        env:
          JOB_CONTEXT: ${{ toJson(job) }}
        run: echo "$JOB_CONTEXT"
      - name: Dump steps context
        env:
          STEPS_CONTEXT: ${{ toJson(steps) }}
        run: echo "$STEPS_CONTEXT"
      - name: Dump runner context
        env:
          RUNNER_CONTEXT: ${{ toJson(runner) }}
        run: echo "$RUNNER_CONTEXT"
      - name: Dump strategy context
        env:
          STRATEGY_CONTEXT: ${{ toJson(strategy) }}
        run: echo "$STRATEGY_CONTEXT"
      - name: Dump matrix context
        env:
          MATRIX_CONTEXT: ${{ toJson(matrix) }}
        run: echo "$MATRIX_CONTEXT"
      - name: Dump env context
        env:
          ENV_CONTEXT: ${{ toJson(env) }}
        run: echo "$ENV_CONTEXT"
